# CI/CD Setup Instructions

Follow these steps to complete your CI/CD setup.

## Step 1: Generate Secrets (1 minute)

Run the secret generator script:

```bash
# Using Node.js (recommended)
pnpm generate:secrets

# Or directly
node scripts/generate-github-secrets.js

# On Windows PowerShell
.\scripts\generate-github-secrets.ps1

# On Linux/Mac
bash scripts/generate-github-secrets.sh
```

This will generate a secure `JWT_SECRET` and show you all the secrets you need.

## Step 2: Add Secrets to GitHub (3 minutes)

1. **Go to your repository on GitHub**
2. **Click Settings** → **Secrets and variables** → **Actions**
3. **Click "New repository secret"**
4. **Add these secrets one by one:**

### Required Secrets

| Secret Name           | Value                            | Notes                       |
| --------------------- | -------------------------------- | --------------------------- |
| `JWT_SECRET`          | (Generated by script)            | Copy from script output     |
| `JWT_EXPIRES_IN`      | `7d`                             | Standard expiration         |
| `NEXT_PUBLIC_API_URL` | `https://api.yourdomain.com/api` | Update with your actual URL |

**Quick Steps:**

1. Copy the `JWT_SECRET` from the script output
2. Click "New repository secret"
3. Name: `JWT_SECRET`, Value: (paste the generated value)
4. Click "Add secret"
5. Repeat for `JWT_EXPIRES_IN` and `NEXT_PUBLIC_API_URL`

## Step 3: Test Workflows (2 minutes)

### Option A: Push This Change

Simply commit and push the current changes:

```bash
git add .
git commit -m "ci: configure CI/CD pipeline and workflows"
git push
```

### Option B: Make a Test Change

Make a small change to trigger workflows:

```bash
# Update the test trigger file
echo "# Test $(date)" >> .github/workflows/.test-workflow-trigger.md

git add .github/workflows/.test-workflow-trigger.md
git commit -m "test: trigger CI workflows"
git push
```

### Verify Workflows

1. Go to the **Actions** tab in GitHub
2. You should see workflows running
3. Wait for them to complete (5-10 minutes)
4. Verify all jobs pass ✅

## Step 4: Set Branch Protection (3 minutes)

1. **Go to Settings** → **Branches**
2. **Click "Add rule"**
3. **Branch name pattern:** `main`
4. **Enable these settings:**

   ✅ **Require a pull request before merging**
   - Require approvals: **1**
   - Dismiss stale pull request approvals when new commits are pushed

   ✅ **Require status checks to pass before merging**
   - Require branches to be up to date before merging
   - Select these required checks:
     - `lint`
     - `type-check`
     - `build`
     - `test-backend`
     - `test-frontend`

   ✅ **Require conversation resolution before merging**

   ✅ **Do not allow bypassing the above settings**

   ❌ **Allow force pushes** (unchecked)

   ❌ **Allow deletions** (unchecked)

   ✅ **Include administrators**

5. **Click "Create"**

**Note:** Status checks will only appear after workflows have run at least once.

## Step 5: Verify Everything Works

### Test with a Pull Request

1. Create a new branch:

   ```bash
   git checkout -b test/ci-workflow
   ```

2. Make a small change:

   ```bash
   echo "# Test PR" >> README.md
   git add README.md
   git commit -m "test: verify CI workflow"
   git push origin test/ci-workflow
   ```

3. Open a Pull Request on GitHub

4. Verify:
   - ✅ Status checks appear
   - ✅ All checks must pass before merging
   - ✅ PR requires approval
   - ✅ Cannot merge if checks fail

## Troubleshooting

### Secrets Not Found

**Error:** `Secret not found` in workflow logs

**Solution:**

- Verify secret names match exactly (case-sensitive)
- Check that secrets are added to the repository
- Ensure you're using `${{ secrets.SECRET_NAME }}` syntax

### Status Checks Not Appearing

**Problem:** Required status checks don't show in branch protection

**Solution:**

1. Push a change to trigger workflows
2. Wait for workflows to complete
3. Refresh the branch protection settings page
4. Status checks should now appear in the dropdown

### Workflows Not Running

**Problem:** Workflows don't trigger on push

**Solution:**

- Check that workflow files are in `.github/workflows/`
- Verify YAML syntax is correct
- Check repository settings → Actions → Workflow permissions
- Ensure workflows are enabled

### Tests Failing

**Problem:** Tests fail in CI but pass locally

**Solution:**

- Check environment variables are set correctly
- Verify database connection (CI uses service container)
- Review test logs for specific errors
- Ensure test data setup is correct

## Quick Reference

### Secret Generator

```bash
pnpm generate:secrets
```

### Test Workflow

```bash
git commit --allow-empty -m "test: trigger workflows"
git push
```

### View Workflows

- GitHub → Actions tab
- See all workflow runs and their status

### Required Secrets Checklist

- [ ] `JWT_SECRET` - Generated secure value
- [ ] `JWT_EXPIRES_IN` - Set to `7d`
- [ ] `NEXT_PUBLIC_API_URL` - Your API URL

### Branch Protection Checklist

- [ ] Rule created for `main` branch
- [ ] Status checks required
- [ ] PR approval required
- [ ] Force push disabled
- [ ] Administrators included

## Next Steps

After setup is complete:

1. ✅ Monitor workflow runs
2. ✅ Configure deployment (optional)
3. ✅ Set up notifications
4. ✅ Review and optimize workflow performance

## Support

- **Quick Start**: [.github/QUICK_START.md](.github/QUICK_START.md)
- **Secrets Guide**: [.github/SECRETS_SETUP.md](.github/SECRETS_SETUP.md)
- **Branch Protection**: [.github/BRANCH_PROTECTION_SETUP.md](.github/BRANCH_PROTECTION_SETUP.md)
- **Full Documentation**: [CICD_SETUP.md](../docs/ci-cd/CICD_SETUP.md)
