// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Phase 1: Tenancy & Subscription
model Cooperative {
  id        String   @id @default(cuid())
  name      String
  subdomain String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  profile                   CooperativeProfile?
  subscription              Subscription?
  users                     User[]
  members                   Member[]
  roles                     Role[]
  chartOfAccounts           ChartOfAccounts[]
  journalEntries            JournalEntry[]
  transactions              Transaction[]
  ledgers                   Ledger[]
  savingProducts            SavingProduct[]
  savingAccounts            SavingAccount[]
  loanProducts              LoanProduct[]
  loanApplications          LoanApplication[]
  productGLMaps             ProductGLMap[]
  emiSchedules              EMISchedule[]
  shareAccounts             ShareAccount[]
  shareTransactions         ShareTransaction[]
  memberDocuments           MemberDocument[]
  officialDocuments         OfficialDocument[]
  dartas                    Darta[]
  dartaDocuments            DartaDocument[]
  dartaMovements            DartaMovement[]
  dartaSerialCounters       DartaSerialCounter[]
  patraChalanis             PatraChalani[]
  patraChalaniDocuments     PatraChalaniDocument[]
  patraChalaniActions       PatraChalaniAction[]
  chalaniSerialCounters     ChalaniSerialCounter[]
  employees                 Employee[]
  payrollLogs               PayrollLog[]
  attendanceLogs            AttendanceLog[]
  meetings                  Meeting[]
  meetingMinutes            MeetingMinute[]
  committees                Committee[]
  agms                      AGM[]
  inventoryCategories       InventoryCategory[]
  inventoryItems            InventoryItem[]
  auditLogs                 AuditLog[]
  memberKYC                 MemberKYC[]
  institutionKYC            InstitutionKYC[]
  memberWorkflowHistory     MemberWorkflowHistory[]
  amlFlags                  AmlFlag[]
  amlTtrReports             AmlTtrReport[]
  sourceOfFundsDeclarations SourceOfFundsDeclaration[]
  amlCases                  AmlCase[]
  accountSignatories        AccountSignatory[]
  processedAmlEvents        ProcessedAmlEvents[]
  whitelistedMatches        WhitelistedMatch[]
  sensitiveDataAccessLogs   SensitiveDataAccessLog[]
  sanctionListUN            SanctionListUN[]
  sanctionListHomeMinistry  SanctionListHomeMinistry[]
  trainingSessions          TrainingSession[]
  trainingAttendance        TrainingAttendance[]
  managerReports            ManagerReport[]
  departments               Department[]
  designations              Designation[]
  shifts                    Shift[]
  leaveTypes                LeaveType[]
  payrollRuns               PayrollRun[]
  payrollSettings           PayrollSettings?
  attendances               Attendance[]
  leaveRequests             LeaveRequest[]
  payrolls                  Payroll[]
  dayBooks                  DayBook[]
  tellerSettlements         TellerSettlement[]
  notifications             Notification[]
  genericWorkflowHistory    GenericWorkflowHistory[]
  fixedDepositProducts      FixedDepositProduct[]
  fixedDepositAccounts      FixedDepositAccount[]

  @@map("cooperatives")
}

model Plan {
  id             String   @id @default(cuid())
  name           String
  monthlyPrice   Decimal  @db.Decimal(10, 2)
  enabledModules Json // e.g., ["cbs", "dms", "hrm"]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  subscriptions Subscription[]

  @@map("plans")
}

model Subscription {
  id            String    @id @default(cuid())
  cooperativeId String    @unique
  planId        String
  status        String // "active", "cancelled", "expired"
  startDate     DateTime  @default(now())
  endDate       DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  plan        Plan        @relation(fields: [planId], references: [id])

  @@map("subscriptions")
}

// Phase 1: IAM
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String
  firstName     String
  lastName      String
  cooperativeId String? // Optional for system admins
  roleId        String?
  isSystemAdmin Boolean  @default(false) // System admin flag
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  cooperative              Cooperative?             @relation(fields: [cooperativeId], references: [id], onDelete: Cascade) // Optional for system admins
  role                     Role?                    @relation(fields: [roleId], references: [id])
  workflowHistory          WorkflowHistory[]        @relation()
  genericWorkflowHistory   GenericWorkflowHistory[] @relation()
  dayBooksBegin            DayBook[]                @relation("DayBeginBy")
  dayBooksEnd              DayBook[]                @relation("DayEndBy")
  tellerSettlements        TellerSettlement[]       @relation("TellerSettlements")
  settlementsExecuted      TellerSettlement[]       @relation("SettlementExecutedBy")
  settlementsApproved      TellerSettlement[]       @relation("SettlementApprovedBy")
  mappedAccounts           ChartOfAccounts[]        @relation("UserAccountMapping")
  notifications            Notification[]
  // DMS Relations
  createdDartas            Darta[]                  @relation("DartaCreatedBy")
  updatedDartas            Darta[]                  @relation("DartaUpdatedBy")
  closedDartas             Darta[]                  @relation("DartaClosedBy")
  dartaMovementsFrom       DartaMovement[]          @relation("DartaMovementFrom")
  dartaMovementsTo         DartaMovement[]          @relation("DartaMovementTo")
  dartaMovementsBy         DartaMovement[]          @relation("DartaMovementBy")
  createdChalanis          PatraChalani[]           @relation("ChalaniCreatedBy")
  updatedChalanis          PatraChalani[]           @relation("ChalaniUpdatedBy")
  completedChalanis        PatraChalani[]           @relation("ChalaniCompletedBy")
  chalaniActionsBy         PatraChalaniAction[]     @relation("ChalaniActionBy")
  chalaniActionsTo         PatraChalaniAction[]     @relation("ChalaniActionTo")
  uploadedDartaDocuments   DartaDocument[]          @relation("DartaDocumentUploadedBy")
  uploadedChalaniDocuments PatraChalaniDocument[]   @relation("ChalaniDocumentUploadedBy")

  @@index([cooperativeId])
  @@index([roleId])
  @@index([isActive])
  @@index([createdAt])
  @@map("users")
}

enum RiskCategory {
  LOW
  MEDIUM
  HIGH
}

enum MemberType {
  INDIVIDUAL
  INSTITUTION
}

enum CommitteeType {
  BOD // Sanchalak Samiti
  ACCOUNT // Lekha Samiti
  LOAN // Rin Upasamiti
  EDUCATION // Shiksha Upasamiti
  OTHER
}

enum AGMStatus {
  PLANNED
  SCHEDULED
  COMPLETED
  CANCELLED
}

enum MeetingStatus {
  PLANNED // Draft mode, setting up agenda
  SCHEDULED // Locked date, notifications sent
  COMPLETED // Meeting happened, attendance taken
  CANCELLED // Cancelled
}

enum MeetingWorkflowStatus {
  DRAFT // Editable
  LOCKED // Cannot change date/time
  MINUTED // Decisions recorded
  FINALIZED // Accounting entry passed, Read-only
}

enum DecisionStatus {
  PENDING
  PASSED
  REJECTED
  DEFERRED
}

enum ReportStatus {
  DRAFT
  FINALIZED
}

enum PayrollScheme {
  SSF
  TRADITIONAL
}

enum ShareTxType {
  PURCHASE // Issue/Buy
  RETURN // Surrender/Return
  TRANSFER // Member to Member
  BONUS // Dividend as Share
}

enum DayBookStatus {
  OPEN
  CLOSED
  EOD_IN_PROGRESS
}

enum TellerSettlementStatus {
  PENDING
  APPROVED
  AUTO_APPROVED
  REQUIRES_APPROVAL
  REVERTED
}

// DMS Enums
enum DartaStatus {
  ACTIVE
  PROCESSING
  COMPLETED
  ARCHIVED
  CANCELLED
}

enum ChalaniStatus {
  DRAFT
  PENDING
  IN_PROGRESS
  APPROVED
  SENT
  COMPLETED
  ARCHIVED
  CANCELLED
}

enum DocumentPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum ChalaniType {
  INCOMING
  OUTGOING
  INTERNAL
}

enum DartaCategory {
  GOVERNMENT_NOTICE
  LOAN_REQUEST
  MEMBER_APPLICATION
  COMPLAINT
  LEGAL_DOCUMENT
  FINANCIAL_REPORT
  MEETING_MINUTE
  OTHER
}

enum ChalaniCategory {
  OFFICIAL_CORRESPONDENCE
  MEMBER_COMMUNICATION
  GOVERNMENT_REPLY
  INTERNAL_MEMO
  FINANCIAL_DOCUMENT
  LEGAL_DOCUMENT
  OTHER
}

enum DartaMovementType {
  CREATE
  FORWARD
  TRANSFER
  RETURN
  APPROVE
  REJECT
  CLOSE
  ARCHIVE
}

enum ChalaniActionType {
  FORWARD
  REPLY
  NOTE
  APPROVE
  REJECT
  COMPLETE
  ARCHIVE
  CANCEL
}

enum StorageProvider {
  LOCAL
  S3
  AZURE_BLOB
  GCS
}

model Member {
  id              String     @id @default(cuid())
  memberNumber    String? // Auto-generated after approval, format: 000000, 000001, etc.
  memberType      MemberType @default(INDIVIDUAL) // "INDIVIDUAL" for natural persons, "INSTITUTION" for legal entities
  firstName       String? // For individuals: first name. For institutions: null
  middleName      String? // Middle name in English (only for individuals)
  lastName        String? // For individuals: last name. For institutions: null
  institutionName String? // For institutions: institution name. For individuals: null
  fullName        String? // Auto-generated full name (firstName + middleName + lastName for individuals, institutionName for institutions, uppercase)
  fullNameNepali  String // Full name in Nepali (compulsory)
  email           String?
  phone           String?
  passwordHash    String? // Hashed password for member login (optional for backward compatibility)
  lastLogin       DateTime?
  cooperativeId   String
  isActive        Boolean    @default(true)
  workflowStatus  String     @default("application") // "application", "under_review", "approved", "bod_pending", "active", "rejected"

  // AML/KYM Fields
  pepStatus         Boolean      @default(false)
  beneficialOwner   Json?
  grandfatherName   String? // For 3-generation identification
  familyDetails     Json? // To support recursive PEP screening
  riskCategory      RiskCategory @default(LOW)
  riskFactors       Json? // Stores reasons, e.g., ["PEP_FAMILY", "OCCUPATION"]
  lastKymUpdate     DateTime?
  nextKymReviewDate DateTime? // Computed based on risk (1, 2, or 3 years)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  cooperative               Cooperative                @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  savingAccounts            SavingAccount[]
  loanApplications          LoanApplication[]
  shareAccount              ShareAccount?
  shareTransactions         ShareTransaction[]
  documents                 MemberDocument[]
  kyc                       MemberKYC?
  institutionKyc            InstitutionKYC?
  memberWorkflowHistory     MemberWorkflowHistory[]    @relation("MemberWorkflowHistory")
  workflowHistory           WorkflowHistory[]          @relation()
  amlFlags                  AmlFlag[]
  amlTtrReports             AmlTtrReport[]
  sourceOfFundsDeclarations SourceOfFundsDeclaration[]
  amlCases                  AmlCase[]
  accountSignatories        AccountSignatory[]
  committeeMembers          CommitteeMember[]
  fixedDepositAccounts      FixedDepositAccount[]

  @@unique([cooperativeId, memberNumber], name: "cooperativeId_memberNumber")
  @@index([cooperativeId, workflowStatus])
  @@index([cooperativeId, isActive])
  @@index([cooperativeId, createdAt])
  @@index([cooperativeId, riskCategory])
  @@index([cooperativeId, nextKymReviewDate])
  @@index([memberNumber])
  @@index([cooperativeId, email])
  @@index([cooperativeId, phone])
  @@map("members")
}

// Member KYM (Know Your Member) Information
model MemberKYC {
  id            String @id @default(cuid())
  memberId      String @unique
  cooperativeId String

  // Personal Information (Section a)
  dateOfBirth                DateTime?
  dateOfBirthBS              String? // Bikram Sambat date (YYYY-MM-DD format, e.g., "2081-01-15")
  gender                     String? // "FEMALE", "MALE", "THIRD"
  nationality                String?
  citizenshipNumber          String?
  citizenshipIssuingOffice   String?
  citizenshipIssuingDistrict String?

  // Family Details (Section b)
  grandfatherName String? // For 3-generation identification
  fatherName      String?
  motherName      String?
  maritalStatus   String? // "MARRIED", "UNMARRIED", "SINGLE"
  spouseName      String?
  spouseSurname   String?
  familyType      String? // "JOINT_ONE_KITCHEN", "JOINT_SEPARATE_KITCHEN", "NUCLEAR"

  // Address Information (Section d)
  permanentProvince     String?
  permanentMunicipality String?
  permanentWard         String?
  permanentVillageTole  String?
  permanentHouseNo      String?
  temporaryProvince     String?
  temporaryMunicipality String?
  temporaryWard         String?
  temporaryVillageTole  String?
  temporaryHouseNo      String?
  residenceType         String? // "PERMANENT", "TEMPORARY"
  residenceDuration     String? // Duration of stay in institution's working area per year

  // Contact Information
  contactNo      String?
  emailId        String?
  voterIdCardNo  String?
  pollingStation String?
  passportNo     String?

  // Occupation Details (Section c)
  occupation              String? // Occupation value from OCCUPATION_OPTIONS
  occupationSpecify       String? // Additional details for Business/Service/etc.
  panNo                   String? // Permanent Account Number
  spouseOccupation        String?
  spouseOccupationSpecify String?

  // PEP Details (Section c)
  isHighRankingPositionHolder Boolean @default(false)
  pepName                     String?
  pepRelationship             String?
  pepPosition                 String?

  // Income Source Details (Section f)
  annualFamilyIncome String? // Income range from ANNUAL_INCOME_RANGES

  // Financial Transaction Details (Section g)
  initialShareAmount           Decimal? @db.Decimal(15, 2)
  initialSavingsAmount         Decimal? @db.Decimal(15, 2)
  initialOtherAmount           Decimal? @db.Decimal(15, 2)
  initialOtherSpecify          String?
  estimatedTransactionsPerYear Int?
  estimatedAnnualDeposit       Decimal? @db.Decimal(15, 2)
  estimatedLoanAmount          Decimal? @db.Decimal(15, 2)
  additionalRemarks            String?

  // Cooperative Membership (Section e)
  membershipObjective                    String?
  isMemberOfAnotherCooperative           Boolean @default(false)
  dualMembershipPurpose                  String?
  isFamilyMemberOfAnotherCooperative     Boolean @default(false)
  familyDualMembershipPurpose            String?
  isAnotherFamilyMemberInThisInstitution Boolean @default(false)

  // Self-Declaration (Section h)
  declarationChangeAgreement Boolean   @default(false)
  declarationTruthfulness    Boolean   @default(false)
  declarationDate            DateTime?

  // Biometrics (Section h)
  signaturePath        String?
  fingerprintRightPath String?
  fingerprintLeftPath  String?

  // Attached Documents (Section i)
  citizenshipCopyPath String?
  voterIdCopyPath     String?
  passportCopyPath    String?

  // Recommendation (Section j) - for new members
  recommender1Name         String?
  recommender1MembershipNo String?
  recommender2Name         String?
  recommender2MembershipNo String?

  // KYM Status
  isComplete    Boolean   @default(false)
  completedAt   DateTime?
  reviewedBy    String? // User ID
  reviewedAt    DateTime?
  approvedBy    String? // User ID
  approvedAt    DateTime?
  bodMeetingId  String? // Meeting ID where approved
  bodApprovedAt DateTime?
  remarks       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  member                             Member                              @relation(fields: [memberId], references: [id], onDelete: Cascade)
  cooperative                        Cooperative                         @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  bodMeeting                         Meeting?                            @relation(fields: [bodMeetingId], references: [id])
  otherCooperativeMemberships        OtherCooperativeMembership[]
  familyMemberCooperativeMemberships FamilyMemberCooperativeMembership[]
  familyMemberInThisInstitution      FamilyMemberInThisInstitution[]
  otherEarningFamilyMembers          OtherEarningFamilyMember[]
  incomeSourceDetails                IncomeSourceDetail[]

  @@map("member_kyc")
}

// Institution KYM (Know Your Member) Information (for Legal Entities)
model InstitutionKYC {
  id            String @id @default(cuid())
  memberId      String @unique
  cooperativeId String

  // Institution Details
  name              String
  registrationNo    String
  registrationDate  DateTime?
  registeringOffice String?
  renewalDate       DateTime?
  headOfficeAddress String?
  mainObjective     String?
  natureOfBusiness  String?
  workingArea       String?
  numberOfBranches  Int?
  branchLocations   String? // JSON array or comma-separated

  // Documents
  bylawsConstitutionPath String? // Path to bylaws/constitution document
  officialLetterPath     String? // Path to official letter if no bylaws
  financialStatementPath String? // Path to financial statements
  taxClearancePath       String? // Path to tax clearance certificate
  taxFilingDetailsPath   String? // Path to tax filing details

  // Financial Information
  estimatedAnnualTransaction Decimal? @db.Decimal(15, 2)
  panVatRegistrationNo       String?

  // Financial Transaction Details (Application Payment)
  // These are required at application time, separate from KYC risk assessment
  initialShareAmount   Decimal? @db.Decimal(15, 2)
  initialSavingsAmount Decimal? @db.Decimal(15, 2)
  initialOtherAmount   Decimal? @db.Decimal(15, 2)
  initialOtherSpecify  String?

  // Board of Directors, CEO, Account Operators
  // Stored as JSON array of objects with identification details per Schedule-1 and Schedule-3
  boardOfDirectors Json? // Array of { name, position, identificationDetails }
  chiefExecutive   Json? // { name, identificationDetails }
  accountOperators Json? // Array of { name, identificationDetails }

  // Board Decision
  boardDecisionPath String? // Path to board decision document
  boardDecisionDate DateTime?

  // Other Details
  otherDetails String?

  // KYM Status
  isComplete    Boolean   @default(false)
  completedAt   DateTime?
  reviewedBy    String? // User ID
  reviewedAt    DateTime?
  approvedBy    String? // User ID
  approvedAt    DateTime?
  bodMeetingId  String? // Meeting ID where approved
  bodApprovedAt DateTime?
  remarks       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  member      Member      @relation(fields: [memberId], references: [id], onDelete: Cascade)
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  bodMeeting  Meeting?    @relation(fields: [bodMeetingId], references: [id])

  @@index([cooperativeId])
  @@index([registrationNo])
  @@index([panVatRegistrationNo])
  @@map("institution_kyc")
}

// Related models for one-to-many relationships

model OtherCooperativeMembership {
  id                 String @id @default(cuid())
  memberKycId        String
  institutionName    String
  institutionAddress String
  membershipNo       String
  sn                 Int // Serial number in the form

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberKyc MemberKYC @relation(fields: [memberKycId], references: [id], onDelete: Cascade)

  @@map("other_cooperative_memberships")
}

model FamilyMemberCooperativeMembership {
  id                      String @id @default(cuid())
  memberKycId             String
  nameSurnameRelationship String
  institutionNameAddress  String
  membershipNo            String
  sn                      Int // Serial number in the form

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberKyc MemberKYC @relation(fields: [memberKycId], references: [id], onDelete: Cascade)

  @@map("family_member_cooperative_memberships")
}

model FamilyMemberInThisInstitution {
  id           String @id @default(cuid())
  memberKycId  String
  nameSurname  String
  membershipNo String
  sn           Int // Serial number in the form

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberKyc MemberKYC @relation(fields: [memberKycId], references: [id], onDelete: Cascade)

  @@map("family_member_in_this_institution")
}

model OtherEarningFamilyMember {
  id                String  @id @default(cuid())
  memberKycId       String
  relationship      String
  occupation        String
  occupationSpecify String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberKyc MemberKYC @relation(fields: [memberKycId], references: [id], onDelete: Cascade)

  @@map("other_earning_family_members")
}

model IncomeSourceDetail {
  id          String  @id @default(cuid())
  memberKycId String
  source      String // "FARMING", "BUSINESS", "DOMESTIC_EMPLOYMENT", "FOREIGN_EMPLOYMENT", "OTHER"
  amount      Decimal @db.Decimal(15, 2)
  sn          Int // Serial number in the form

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberKyc MemberKYC @relation(fields: [memberKycId], references: [id], onDelete: Cascade)

  @@map("income_source_details")
}

// Member Workflow History
model MemberWorkflowHistory {
  id            String   @id @default(cuid())
  memberId      String
  cooperativeId String
  fromStatus    String?
  toStatus      String
  action        String // "kyc_submitted", "kyc_reviewed", "kyc_approved", "sent_to_bod", "bod_approved", "activated", "rejected"
  performedBy   String? // User ID
  remarks       String?
  createdAt     DateTime @default(now())

  // Relations
  member      Member      @relation("MemberWorkflowHistory", fields: [memberId], references: [id], onDelete: Cascade)
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([cooperativeId, toStatus])
  @@index([cooperativeId, action])
  @@index([performedBy])
  @@index([createdAt])
  @@map("member_workflow_history")
}

// Workflow History - Next-Level Improvement for accurate analytics
model WorkflowHistory {
  id            String   @id @default(uuid())
  cooperativeId String
  memberId      String
  member        Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  changedById   String? // ID of the staff member who made the change
  changedBy     User?    @relation(fields: [changedById], references: [id], onDelete: SetNull)
  fromStatus    String? // e.g., 'application' (null for initial creation)
  toStatus      String // e.g., 'under_review'
  changedAt     DateTime @default(now())
  remarks       String? // e.g., "Rejected: Mismatched signature"

  @@index([memberId])
  @@index([cooperativeId, toStatus])
  @@map("workflow_history")
}

model Role {
  id            String   @id @default(cuid())
  name          String
  cooperativeId String
  permissions   Json // Array of permission strings
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  users       User[]

  @@unique([cooperativeId, name])
  @@map("roles")
}

// Phase 1: Onboarding & Public Profile
model CooperativeProfile {
  id            String   @id @default(cuid())
  cooperativeId String   @unique
  description   String?
  logoUrl       String?
  website       String?
  address       String?
  phone         String?
  email         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)

  @@map("cooperative_profiles")
}

// Phase 1: Double-Entry Accounting Engine (CBS Part 1)
model ChartOfAccounts {
  id            String   @id @default(cuid())
  code          String
  name          String
  type          String // "asset", "liability", "equity", "revenue", "expense"
  cooperativeId String
  parentId      String?
  isActive      Boolean  @default(true)
  isGroup       Boolean  @default(false) // Distinguish between folder (cannot satisfy transaction) and ledger (can satisfy transaction)
  nfrsMap       String? // NFRS note references (e.g., '4.1', '4.12') for automatic report generation
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  cooperative   Cooperative       @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  parent        ChartOfAccounts?  @relation("AccountHierarchy", fields: [parentId], references: [id])
  children      ChartOfAccounts[] @relation("AccountHierarchy")
  ledgerEntries Ledger[]
  mappedUserId  String?
  mappedUser    User?             @relation("UserAccountMapping", fields: [mappedUserId], references: [id])

  @@unique([cooperativeId, code])
  @@index([cooperativeId, type])
  @@index([cooperativeId, isActive])
  @@index([cooperativeId, parentId])
  @@index([code])
  @@map("chart_of_accounts")
}

model Ledger {
  id             String   @id @default(cuid())
  accountId      String
  cooperativeId  String
  debit          Decimal  @default(0) @db.Decimal(15, 2)
  credit         Decimal  @default(0) @db.Decimal(15, 2)
  balance        Decimal  @default(0) @db.Decimal(15, 2)
  transactionId  String?
  journalEntryId String?
  createdAt      DateTime @default(now())

  // Relations
  cooperative  Cooperative     @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  account      ChartOfAccounts @relation(fields: [accountId], references: [id])
  transaction  Transaction?    @relation(fields: [transactionId], references: [id])
  journalEntry JournalEntry?   @relation(fields: [journalEntryId], references: [id])

  @@index([cooperativeId, accountId])
  @@index([cooperativeId, createdAt])
  @@index([accountId])
  @@index([journalEntryId])
  @@index([transactionId])
  @@map("ledgers")
}

model JournalEntry {
  id            String   @id @default(cuid())
  entryNumber   String
  description   String
  cooperativeId String
  date          DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  ledgers     Ledger[]

  @@unique([cooperativeId, entryNumber])
  @@index([cooperativeId, date])
  @@index([cooperativeId, createdAt])
  @@index([entryNumber])
  @@map("journal_entries")
}

model Transaction {
  id                String   @id @default(cuid())
  transactionNumber String
  description       String
  cooperativeId     String
  amount            Decimal  @db.Decimal(15, 2)
  type              String // "debit", "credit"
  date              DateTime @default(now())
  createdAt         DateTime @default(now())

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  ledgers     Ledger[]

  @@unique([cooperativeId, transactionNumber])
  @@index([cooperativeId, date])
  @@index([cooperativeId, type])
  @@index([cooperativeId, createdAt])
  @@index([transactionNumber])
  @@map("transactions")
}

// Phase 2: Financial Product Modules (CBS Part 2)
// Savings Module
model SavingProduct {
  id                        String   @id @default(cuid())
  code                      String
  name                      String
  description               String?
  interestRate              Decimal  @db.Decimal(5, 2) // Annual interest rate percentage
  minimumBalance            Decimal  @default(0) @db.Decimal(15, 2)
  interestPostingFrequency  String   @default("QUARTERLY") // "QUARTERLY", "ANNUALLY", etc.
  interestCalculationMethod String   @default("DAILY_BALANCE") // "DAILY_BALANCE"
  isTaxApplicable           Boolean  @default(true)
  taxRate                   Decimal  @default(6.0) @db.Decimal(5, 2) // Standard TDS rate (6%)
  cooperativeId             String
  isActive                  Boolean  @default(true)
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  // Relations
  cooperative Cooperative     @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  accounts    SavingAccount[]

  @@unique([cooperativeId, code])
  @@map("saving_products")
}

model SavingAccount {
  id                         String    @id @default(cuid())
  accountNumber              String
  memberId                   String
  productId                  String
  cooperativeId              String
  balance                    Decimal   @default(0) @db.Decimal(15, 2)
  interestAccrued            Decimal   @default(0) @db.Decimal(15, 2)
  status                     String // "active", "closed", "dormant"
  openedDate                 DateTime  @default(now())
  closedDate                 DateTime?
  lastInterestCalculatedDate DateTime?
  lastInterestPostedDate     DateTime?
  nominee                    Json? // Stores name, relation, citizenship, photo
  createdAt                  DateTime  @default(now())
  updatedAt                  DateTime  @updatedAt

  // Relations
  cooperative Cooperative   @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  member      Member        @relation(fields: [memberId], references: [id], onDelete: Cascade)
  product     SavingProduct @relation(fields: [productId], references: [id])

  @@unique([cooperativeId, accountNumber])
  @@index([cooperativeId, memberId])
  @@index([cooperativeId, status])
  @@index([cooperativeId, productId])
  @@index([memberId])
  @@index([accountNumber])
  @@map("saving_accounts")
}

// Loans Module
model LoanProduct {
  id              String   @id @default(cuid())
  code            String
  name            String
  description     String?
  interestRate    Decimal  @db.Decimal(5, 2) // Annual interest rate percentage
  maxLoanAmount   Decimal  @db.Decimal(15, 2)
  minLoanAmount   Decimal  @default(0) @db.Decimal(15, 2)
  maxTenureMonths Int
  minTenureMonths Int      @default(1)
  processingFee   Decimal  @default(0) @db.Decimal(15, 2)
  cooperativeId   String
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  cooperative  Cooperative       @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  applications LoanApplication[]

  @@unique([cooperativeId, code])
  @@map("loan_products")
}

model LoanApplication {
  id                String    @id @default(cuid())
  applicationNumber String
  memberId          String
  productId         String
  cooperativeId     String
  loanAmount        Decimal   @db.Decimal(15, 2)
  tenureMonths      Int
  interestRate      Decimal   @db.Decimal(5, 2)
  purpose           String?
  status            String // "pending", "approved", "rejected", "disbursed", "closed"
  appliedDate       DateTime  @default(now())
  approvedDate      DateTime?
  disbursedDate     DateTime?
  closedDate        DateTime?
  remarks           String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  cooperative Cooperative   @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  member      Member        @relation(fields: [memberId], references: [id], onDelete: Cascade)
  product     LoanProduct   @relation(fields: [productId], references: [id])
  emiSchedule EMISchedule[]

  @@unique([cooperativeId, applicationNumber])
  @@index([cooperativeId, memberId])
  @@index([cooperativeId, status])
  @@index([cooperativeId, productId])
  @@index([cooperativeId, appliedDate])
  @@index([memberId])
  @@index([applicationNumber])
  @@map("loan_applications")
}

model EMISchedule {
  id                String    @id @default(cuid())
  applicationId     String
  cooperativeId     String
  installmentNumber Int
  dueDate           DateTime
  principalAmount   Decimal   @db.Decimal(15, 2)
  interestAmount    Decimal   @db.Decimal(15, 2)
  totalAmount       Decimal   @db.Decimal(15, 2)
  paidAmount        Decimal   @default(0) @db.Decimal(15, 2)
  paidDate          DateTime?
  status            String // "pending", "paid", "overdue", "partial"
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  cooperative Cooperative     @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  application LoanApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@unique([applicationId, installmentNumber])
  @@index([applicationId])
  @@index([cooperativeId, dueDate])
  @@index([cooperativeId, status])
  @@index([dueDate])
  @@index([status])
  @@map("emi_schedules")
}

// Product GL Mapping - Dynamic mapping of products to Chart of Accounts
// Note: productId is a generic string reference (polymorphic). Use productType to determine which table it references.
model ProductGLMap {
  id            String @id @default(cuid())
  cooperativeId String
  productType   String // "loan" or "saving"
  productId     String // ID of LoanProduct or SavingProduct (polymorphic - handled in application code)

  // GL Account Mappings
  // For Loan Products:
  principalGLCode      String? // Principal Asset GL (e.g., "00-10400-01-00000")
  interestIncomeGLCode String? // Interest Income GL (e.g., "00-40100-01-00001")
  penaltyIncomeGLCode  String? // Penalty/Fine Income GL (e.g., "00-40400-00-00002")

  // For Saving Products:
  depositGLCode         String? // Deposit Liability GL (e.g., "00-20100-01-00000")
  interestExpenseGLCode String? // Interest Expense GL (e.g., "00-50100-01-00001")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)

  @@unique([cooperativeId, productType, productId])
  @@index([productType, productId])
  @@map("product_gl_maps")
}

// Fixed Deposits (FD)
enum FDInterestPostingFrequency {
  MONTHLY
  QUARTERLY
  HALF_YEARLY
  YEARLY
  AT_MATURITY
}

enum FDPenaltyType {
  LOWER_RATE // Recalculate whole tenure at lower rate (e.g. savings rate)
  DEDUCT_INTEREST // Deduct % of accrued interest
}

model FixedDepositProduct {
  id            String  @id @default(cuid())
  cooperativeId String
  name          String
  description   String?

  // Terms
  minAmount Decimal  @db.Decimal(15, 2)
  maxAmount Decimal? @db.Decimal(15, 2)

  // Interest
  interestRate     Decimal                    @db.Decimal(5, 2) // e.g., 12.50
  postingFrequency FDInterestPostingFrequency @default(AT_MATURITY)

  // Duration in months
  durationMonths Int // e.g. 12 for 1 year

  // Penalty Configuration
  penaltyType        FDPenaltyType @default(LOWER_RATE)
  penaltyValue       Decimal?      @db.Decimal(5, 2) // e.g. 2.00% reduction or 5% deduction
  isPrematureAllowed Boolean       @default(true)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  cooperative Cooperative           @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  accounts    FixedDepositAccount[]

  @@unique([cooperativeId, name])
  @@map("fixed_deposit_products")
}

enum FDAccountStatus {
  ACTIVE
  MATURED
  CLOSED
  PREMATURE_CLOSED
}

model FixedDepositAccount {
  id            String @id @default(cuid())
  cooperativeId String
  memberId      String
  productId     String

  // Account Details
  accountNumber String  @unique // Auto-generated
  principal     Decimal @db.Decimal(15, 2)
  interestRate  Decimal @db.Decimal(5, 2) // Locked-in rate at creation

  // Dates
  startDate    DateTime
  maturityDate DateTime
  closedAt     DateTime?

  // Financials
  accruedInterest Decimal @default(0) @db.Decimal(15, 2) // Interest earned so far
  paidInterest    Decimal @default(0) @db.Decimal(15, 2) // Interest already paid out

  // Nominee
  nomineeName       String?
  nomineeRelation   String?
  nomineePhone      String?
  nomineeFatherName String?

  status  FDAccountStatus @default(ACTIVE)
  remarks String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  cooperative Cooperative         @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  member      Member              @relation(fields: [memberId], references: [id], onDelete: Restrict)
  product     FixedDepositProduct @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([cooperativeId, memberId])
  @@index([cooperativeId, status])
  @@index([maturityDate])
  @@map("fixed_deposit_accounts")
}

// Shares Module
model ShareAccount {
  id            String @id @default(uuid())
  cooperativeId String

  memberId String @unique
  member   Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  // Balances
  totalKitta  Int   @default(0) // Total quantity
  unitPrice   Float @default(100) // Face value (usually 100)
  totalAmount Float @default(0) // totalKitta * unitPrice

  // Certificate Info
  certificateNo String? // e.g., "CERT-000001"
  issueDate     DateTime @default(now())

  transactions ShareTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)

  @@index([cooperativeId])
  @@map("share_accounts")
}

model ShareTransaction {
  id String @id @default(uuid())

  accountId String
  account   ShareAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  memberId      String
  cooperativeId String

  transactionNo String // Auto-generated e.g. "TX-SHARE-2081-001"
  type          ShareTxType
  date          DateTime

  // Transaction Details
  kitta  Int // Positive for Purchase/Bonus, Negative for Return
  amount Float // Monetary value

  // Payment Details
  paymentMode String // "CASH", "BANK", "SAVING", "ADJUSTMENT"

  // Links
  journalId String? // Link to Accounting Journal Entry

  remarks   String?
  createdBy String // User ID of staff

  createdAt DateTime @default(now())

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  member      Member      @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([cooperativeId, transactionNo])
  @@index([accountId])
  @@index([cooperativeId, memberId])
  @@index([cooperativeId, date])
  @@index([cooperativeId, type])
  @@index([memberId])
  @@index([transactionNo])
  @@map("share_transactions")
}

// Phase 3: ERP & Operations Modules (Add-ons)
// Document Management System (DMS)
model MemberDocument {
  id            String   @id @default(cuid())
  memberId      String
  cooperativeId String
  documentType  String // "id", "photo", "contract", "other"
  fileName      String
  filePath      String
  fileSize      Int? // Size in bytes
  mimeType      String?
  description   String?
  uploadedBy    String? // User ID who uploaded
  uploadedAt    DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  member      Member      @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([cooperativeId, memberId])
  @@index([memberId])
  @@index([documentType])
  @@map("member_documents")
}

model OfficialDocument {
  id            String    @id @default(cuid())
  cooperativeId String
  documentType  String // "policy", "regulation", "report", "certificate", "other"
  title         String
  fileName      String
  filePath      String
  fileSize      Int? // Size in bytes
  mimeType      String?
  description   String?
  category      String?
  version       String?   @default("1.0")
  isPublic      Boolean   @default(false)
  uploadedBy    String? // User ID who uploaded
  uploadedAt    DateTime  @default(now())
  effectiveDate DateTime?
  expiryDate    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)

  @@map("official_documents")
}

// ============================================================================
// DMS (Document Management System) - Darta & Patra Chalani
// ============================================================================
// 
// ATOMIC SERIAL NUMBER GENERATION:
// - Use DartaSerialCounter/ChalaniSerialCounter tables for race-condition safe numbering
// - Transaction flow: BEGIN -> SELECT FOR UPDATE -> INCREMENT -> COMMIT
// - Example: UPDATE darta_serial_counters SET lastSerialNo = lastSerialNo + 1 
//            WHERE cooperativeId = ? AND fiscalYear = ? RETURNING lastSerialNo;
//
// DATE VALIDATION CONSTRAINTS (Application-level, not DB-level):
// - Darta: senderChalaniDate <= receivedDate (if both provided)
// - PatraChalani: receivedDate <= date (for incoming), date <= sentDate (for outgoing)
// - These should be enforced in application code or via Prisma middleware
//
// FULL-TEXT SEARCH:
// - Add PostgreSQL GIN indexes via raw SQL migration:
//   CREATE INDEX idx_darta_title_gin ON dartas USING gin(to_tsvector('nepali', title));
//   CREATE INDEX idx_darta_subject_gin ON dartas USING gin(to_tsvector('nepali', subject));
//   CREATE INDEX idx_chalani_subject_gin ON patra_chalanis USING gin(to_tsvector('nepali', subject));
//
// ============================================================================

// Serial Number Counter for Atomic Generation (Race-condition safe)
model DartaSerialCounter {
  id            String   @id @default(cuid())
  cooperativeId String
  fiscalYear    String // e.g., "2081/82"
  lastSerialNo  Int      @default(0)
  updatedAt     DateTime @updatedAt

  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)

  @@unique([cooperativeId, fiscalYear])
  @@index([cooperativeId, fiscalYear])
  @@map("darta_serial_counters")
}

model ChalaniSerialCounter {
  id            String   @id @default(cuid())
  cooperativeId String
  fiscalYear    String // e.g., "2081/82"
  lastSerialNo  Int      @default(0)
  updatedAt     DateTime @updatedAt

  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)

  @@unique([cooperativeId, fiscalYear])
  @@index([cooperativeId, fiscalYear])
  @@map("chalani_serial_counters")
}

// Darta (File/Record Management System)
model Darta {
  id            String @id @default(cuid())
  cooperativeId String

  // Smart Numbering (Atomic via Counter Table)
  fiscalYear  String // e.g., "2081/82" (Use for resets)
  serialNo    Int // e.g., 1 (Resets every fiscal year, generated atomically)
  dartaNumber String @unique // Auto-generated formatted (e.g., "D-081/82-001")

  // Document Details
  title       String
  description String?          @db.Text
  subject     String? // Subject matter (विषय)
  category    DartaCategory?
  status      DartaStatus      @default(ACTIVE)
  priority    DocumentPriority @default(NORMAL)
  remarks     String?          @db.Text

  // Source Info (पत्र पठाउनेको विवरण)
  senderName        String // Received From (Organization/Person Name)
  senderAddress     String? // Sender's address
  senderChalaniNo   String? // प्राप्त पत्रको चलानी नं. (Reference from sender)
  senderChalaniDate DateTime? // प्राप्त पत्रको मिति
  receivedDate      DateTime  @default(now()) // दर्ता मिति (Registration Date)

  // Tracking & Public Access
  qrCode                String? @unique // QR code for public tracking
  trackingCode          String? @unique // Public tracking code (e.g., "TRK-ABC123")
  publicTrackingEnabled Boolean @default(false) // Allow public tracking page

  // Audit Trail
  createdBy     String?
  createdByUser User?   @relation("DartaCreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  updatedBy     String?
  updatedByUser User?   @relation("DartaUpdatedBy", fields: [updatedBy], references: [id], onDelete: SetNull)
  closedBy      String?
  closedByUser  User?   @relation("DartaClosedBy", fields: [closedBy], references: [id], onDelete: SetNull)

  // Soft Delete & Archival
  deletedAt      DateTime?
  deletedBy      String?
  isArchived     Boolean   @default(false)
  archivedAt     DateTime?
  archivedBy     String?
  retentionUntil DateTime? // Auto-archive after this date

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  closedAt  DateTime?

  // Relations
  cooperative       Cooperative     @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  documents         DartaDocument[]
  movements         DartaMovement[]
  generatedChalanis PatraChalani[]  @relation("DartaToChalani") // Chalani generated from this Darta

  // Constraints & Indexes
  @@unique([cooperativeId, fiscalYear, serialNo]) // Ensures numbering is unique per Cooperative per Fiscal Year
  @@index([cooperativeId, status])
  @@index([cooperativeId, fiscalYear])
  @@index([cooperativeId, receivedDate])
  @@index([cooperativeId, category])
  @@index([cooperativeId, priority])
  @@index([cooperativeId, isArchived, deletedAt])
  @@index([dartaNumber]) // Fast lookup by number
  @@index([trackingCode]) // Public tracking lookup
  @@index([qrCode]) // QR code lookup
  // Note: Full-text search indexes (GIN for title, subject, description) should be added via raw SQL migration
  // Example: CREATE INDEX idx_darta_title_gin ON dartas USING gin(to_tsvector('nepali', title));
  @@map("dartas")
}

model DartaDocument {
  id            String @id @default(cuid())
  dartaId       String
  cooperativeId String

  // Document Metadata
  title       String
  fileName    String
  description String?

  // Storage Information
  storageProvider    StorageProvider @default(LOCAL)
  filePath           String // Local path or S3 key
  fileUrl            String? // Public/Pre-signed URL
  fileSize           Int? // Size in bytes
  mimeType           String?
  contentDisposition String? // "inline" or "attachment"

  // S3/Cloud Storage Metadata
  bucket   String? // S3 bucket name
  key      String? // S3 object key
  region   String? // AWS region
  fileHash String? // SHA-256 hash for integrity
  etag     String? // S3 ETag

  // Versioning
  version           Int     @default(1)
  isLatest          Boolean @default(true)
  previousVersionId String? // Link to previous version

  // Audit
  uploadedBy     String?
  uploadedByUser User?    @relation("DartaDocumentUploadedBy", fields: [uploadedBy], references: [id], onDelete: SetNull)
  uploadedAt     DateTime @default(now())

  // Soft Delete
  deletedAt DateTime?
  deletedBy String?

  // Retention
  retentionUntil DateTime? // Auto-delete after this date

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  darta       Darta       @relation(fields: [dartaId], references: [id], onDelete: Cascade)

  @@index([dartaId])
  @@index([cooperativeId, deletedAt])
  @@index([fileHash]) // For duplicate detection
  @@map("darta_documents")
}

model DartaMovement {
  id            String @id @default(cuid())
  dartaId       String
  cooperativeId String

  // Movement Details
  movementType   DartaMovementType
  fromUserId     String? // User who sent/transferred
  toUserId       String? // User who received
  fromDepartment String? // Department/office from
  toDepartment   String? // Department/office to
  remarks        String?           @db.Text

  // Audit
  movedBy String? // User who performed the movement
  movedAt DateTime @default(now())

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  darta       Darta       @relation(fields: [dartaId], references: [id], onDelete: Cascade)
  fromUser    User?       @relation("DartaMovementFrom", fields: [fromUserId], references: [id], onDelete: SetNull)
  toUser      User?       @relation("DartaMovementTo", fields: [toUserId], references: [id], onDelete: SetNull)
  movedByUser User?       @relation("DartaMovementBy", fields: [movedBy], references: [id], onDelete: SetNull)

  @@index([dartaId])
  @@index([cooperativeId, movedAt])
  @@index([fromUserId])
  @@index([toUserId])
  @@index([movementType])
  @@map("darta_movements")
}

// Patra Chalani (Letter Dispatch/Correspondence System)
model PatraChalani {
  id            String @id @default(cuid())
  cooperativeId String

  // Smart Numbering (Atomic via Counter Table)
  fiscalYear    String // e.g., "2081/82"
  serialNo      Int // e.g., 1 (Generated atomically)
  chalaniNumber String @unique // Auto-generated (e.g., "C-081/82-001")

  // Link to Darta (Reply)
  replyToDartaId String?
  replyToDarta   Darta?  @relation("DartaToChalani", fields: [replyToDartaId], references: [id], onDelete: SetNull)
  patraNumber    String? // Reference letter number (if replying to external letter)

  // Document Details
  type     ChalaniType
  subject  String
  content  String?          @db.Text // पत्रको ब्यहोरा (Letter content)
  category ChalaniCategory?
  status   ChalaniStatus    @default(DRAFT)
  priority DocumentPriority @default(NORMAL)
  remarks  String?          @db.Text

  // Receiver/Sender Details
  receiverName    String // पत्र पाउने संस्था वा व्यक्ति
  receiverAddress String?
  senderName      String? // Sender (usually our office for outgoing)
  senderAddress   String? // Our office address

  // Dispatch Details
  date          DateTime // Letter date (पत्रको मिति)
  receivedDate  DateTime? // Date received (for incoming)
  sentDate      DateTime? // Date sent (चलानी मिति)
  transportMode String? // "Email", "Post Office", "By Hand", "Courier"

  // CC/BODHARTHA
  bodhartha String? @db.Text // CC to other departments/orgs

  // Tracking & Public Access
  qrCode                String? @unique // QR code for public tracking
  trackingCode          String? @unique // Public tracking code
  publicTrackingEnabled Boolean @default(false)

  // Audit Trail
  createdBy       String?
  createdByUser   User?   @relation("ChalaniCreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  updatedBy       String?
  updatedByUser   User?   @relation("ChalaniUpdatedBy", fields: [updatedBy], references: [id], onDelete: SetNull)
  completedBy     String?
  completedByUser User?   @relation("ChalaniCompletedBy", fields: [completedBy], references: [id], onDelete: SetNull)

  // Soft Delete & Archival
  deletedAt      DateTime?
  deletedBy      String?
  isArchived     Boolean   @default(false)
  archivedAt     DateTime?
  archivedBy     String?
  retentionUntil DateTime?

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  // Relations
  cooperative Cooperative            @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  documents   PatraChalaniDocument[]
  actions     PatraChalaniAction[]

  // Constraints & Indexes
  @@unique([cooperativeId, fiscalYear, serialNo]) // Ensures numbering is unique per Cooperative per Fiscal Year
  @@index([cooperativeId, type, status])
  @@index([cooperativeId, date])
  @@index([cooperativeId, fiscalYear])
  @@index([cooperativeId, category])
  @@index([cooperativeId, priority])
  @@index([cooperativeId, isArchived, deletedAt])
  @@index([chalaniNumber]) // Fast lookup by number
  @@index([trackingCode]) // Public tracking lookup
  @@index([qrCode]) // QR code lookup
  @@index([replyToDartaId]) // Link to source Darta
  // Note: Full-text search indexes for subject/content should be added via raw SQL migration
  @@map("patra_chalanis")
}

model PatraChalaniDocument {
  id             String @id @default(cuid())
  patraChalaniId String
  cooperativeId  String

  // Document Metadata
  title       String
  fileName    String
  description String?

  // Storage Information
  storageProvider    StorageProvider @default(LOCAL)
  filePath           String // Local path or S3 key
  fileUrl            String? // Public/Pre-signed URL
  fileSize           Int? // Size in bytes
  mimeType           String?
  contentDisposition String? // "inline" or "attachment"

  // S3/Cloud Storage Metadata
  bucket   String? // S3 bucket name
  key      String? // S3 object key
  region   String? // AWS region
  fileHash String? // SHA-256 hash for integrity
  etag     String? // S3 ETag

  // Versioning
  version           Int     @default(1)
  isLatest          Boolean @default(true)
  previousVersionId String? // Link to previous version

  // Audit
  uploadedBy     String?
  uploadedByUser User?    @relation("ChalaniDocumentUploadedBy", fields: [uploadedBy], references: [id], onDelete: SetNull)
  uploadedAt     DateTime @default(now())

  // Soft Delete
  deletedAt DateTime?
  deletedBy String?

  // Retention
  retentionUntil DateTime? // Auto-delete after this date

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  cooperative  Cooperative  @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  patraChalani PatraChalani @relation(fields: [patraChalaniId], references: [id], onDelete: Cascade)

  @@index([patraChalaniId])
  @@index([cooperativeId, deletedAt])
  @@index([fileHash]) // For duplicate detection
  @@map("patra_chalani_documents")
}

model PatraChalaniAction {
  id             String @id @default(cuid())
  patraChalaniId String
  cooperativeId  String

  // Action Details
  actionType ChalaniActionType
  actionTo   String? // User/Department action is forwarded to
  remarks    String?           @db.Text
  actionDate DateTime          @default(now())

  // Audit
  actionBy String? // User who performed the action

  // Relations
  cooperative  Cooperative  @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  patraChalani PatraChalani @relation(fields: [patraChalaniId], references: [id], onDelete: Cascade)
  actionByUser User?        @relation("ChalaniActionBy", fields: [actionBy], references: [id], onDelete: SetNull)
  actionToUser User?        @relation("ChalaniActionTo", fields: [actionTo], references: [id], onDelete: SetNull)

  @@index([patraChalaniId])
  @@index([cooperativeId, actionDate])
  @@index([actionType])
  @@index([actionBy])
  @@map("patra_chalani_actions")
}

// Human Resource Management (HRM)
model Department {
  id            String   @id @default(cuid())
  cooperativeId String
  name          String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  employees   Employee[]

  @@unique([cooperativeId, name])
  @@map("departments")
}

model Designation {
  id            String   @id @default(cuid())
  cooperativeId String
  title         String
  rank          Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  employees   Employee[]

  @@unique([cooperativeId, title])
  @@map("designations")
}

model Shift {
  id               String   @id @default(cuid())
  cooperativeId    String
  name             String
  expectedCheckIn  DateTime
  expectedCheckOut DateTime
  graceMinutes     Int      @default(5)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  cooperative Cooperative  @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  employees   Employee[]
  attendances Attendance[]

  @@unique([cooperativeId, name])
  @@map("shifts")
}

model Employee {
  id             String       @id @default(cuid())
  cooperativeId  String
  userId         String?
  code           String // Employee code (e.g., EMP-001)
  firstName      String
  lastName       String
  email          String?
  phone          String?
  address        String?
  employeeNumber String // Keep for backward compatibility
  position       String? // Keep for backward compatibility
  departmentId   String?
  department     Department?  @relation(fields: [departmentId], references: [id])
  designationId  String?
  designation    Designation? @relation(fields: [designationId], references: [id])
  joinDate       DateTime
  basicSalary    Decimal      @db.Decimal(15, 2)
  defaultShiftId String?
  defaultShift   Shift?       @relation(fields: [defaultShiftId], references: [id])
  status         String       @default("active") // "active", "inactive", "terminated"
  terminatedDate DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  cooperative        Cooperative            @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  payrollLogs        PayrollLog[]
  attendanceLogs     AttendanceLog[]
  attendances        Attendance[]
  leaves             LeaveRequest[]
  payrolls           Payroll[]
  leaveBalances      EmployeeLeaveBalance[]
  trainingAttendance TrainingAttendance[]

  @@unique([cooperativeId, code])
  @@unique([cooperativeId, employeeNumber])
  @@index([cooperativeId, status])
  @@index([cooperativeId, departmentId])
  @@index([cooperativeId, designationId])
  @@index([departmentId])
  @@index([code])
  @@map("employees")
}

model PayrollLog {
  id             String    @id @default(cuid())
  employeeId     String
  cooperativeId  String
  payPeriodStart DateTime
  payPeriodEnd   DateTime
  grossSalary    Decimal   @db.Decimal(15, 2)
  deductions     Decimal   @default(0) @db.Decimal(15, 2)
  netSalary      Decimal   @db.Decimal(15, 2)
  paymentDate    DateTime?
  status         String    @default("pending") // "pending", "paid", "cancelled"
  remarks        String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  employee    Employee    @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([cooperativeId, employeeId])
  @@index([cooperativeId, status])
  @@index([cooperativeId, payPeriodStart])
  @@index([employeeId])
  @@map("payroll_logs")
}

model AttendanceLog {
  id            String    @id @default(cuid())
  employeeId    String
  cooperativeId String
  date          DateTime  @default(now())
  checkIn       DateTime?
  checkOut      DateTime?
  hoursWorked   Decimal?  @db.Decimal(5, 2)
  status        String    @default("present") // "present", "absent", "late", "leave", "holiday"
  remarks       String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  employee    Employee    @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, date])
  @@index([cooperativeId, employeeId])
  @@index([cooperativeId, date])
  @@index([cooperativeId, status])
  @@index([employeeId])
  @@map("attendance_logs")
}

model Attendance {
  id               String    @id @default(cuid())
  employeeId       String
  cooperativeId    String
  date             DateTime
  checkIn          DateTime?
  checkOut         DateTime?
  status           String // PRESENT, ABSENT, LATE, LEAVE
  shiftId          String?
  shift            Shift?    @relation(fields: [shiftId], references: [id])
  expectedCheckIn  DateTime?
  expectedCheckOut DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  employee    Employee    @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, date])
  @@index([cooperativeId, employeeId])
  @@index([cooperativeId, date])
  @@index([cooperativeId, status])
  @@index([employeeId])
  @@map("attendances")
}

model LeaveType {
  id                 String   @id @default(cuid())
  cooperativeId      String
  name               String
  isPaid             Boolean  @default(true)
  defaultAnnualQuota Int      @default(0)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  cooperative   Cooperative            @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  leaveRequests LeaveRequest[]
  leaveBalances EmployeeLeaveBalance[]

  @@unique([cooperativeId, name])
  @@map("leave_types")
}

model LeaveRequest {
  id            String    @id @default(cuid())
  employeeId    String
  leaveTypeId   String
  cooperativeId String
  startDate     DateTime
  endDate       DateTime
  days          Float
  status        String    @default("PENDING") // PENDING, APPROVED, REJECTED
  comment       String?
  approvedBy    String?
  approvedAt    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  employee    Employee    @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  leaveType   LeaveType   @relation(fields: [leaveTypeId], references: [id])

  @@index([cooperativeId, employeeId])
  @@index([cooperativeId, status])
  @@index([cooperativeId, startDate])
  @@index([employeeId])
  @@map("leave_requests")
}

model EmployeeLeaveBalance {
  id          String   @id @default(cuid())
  employeeId  String
  leaveTypeId String
  fiscalYear  String
  totalQuota  Float
  usedDays    Float    @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  employee  Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  leaveType LeaveType @relation(fields: [leaveTypeId], references: [id])

  @@unique([employeeId, leaveTypeId, fiscalYear])
  @@map("employee_leave_balances")
}

model PayrollRun {
  id             String    @id @default(cuid())
  cooperativeId  String
  fiscalYear     String // "2082/83"
  monthBs        Int // 1-12 (Baishakh=1, Chaitra=12)
  totalBasic     Float     @default(0)
  totalNetPay    Float     @default(0)
  totalSSF       Float     @default(0)
  totalTDS       Float     @default(0)
  status         String    @default("DRAFT") // DRAFT, FINALIZED
  journalEntryId String?
  finalizedAt    DateTime?
  finalizedBy    String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  payrolls    Payroll[]

  @@unique([cooperativeId, fiscalYear, monthBs])
  @@index([cooperativeId, status])
  @@index([cooperativeId, fiscalYear])
  @@map("payroll_runs")
}

model Payroll {
  id            String      @id @default(cuid())
  employeeId    String
  payrollRunId  String?
  payrollRun    PayrollRun? @relation(fields: [payrollRunId], references: [id])
  cooperativeId String
  fiscalYear    String // e.g., "2082/83"
  monthBs       Int // 1-12
  basicSalary   Float
  allowances    Json // { grade: 1000, fuel: 500 }
  taxTds        Float       @default(0)
  ssfEmployee   Float       @default(0) // 11%
  ssfEmployer   Float       @default(0) // 20%
  loanDeduction Float       @default(0)
  festivalBonus Float       @default(0)
  netSalary     Float
  isPaid        Boolean     @default(false)
  finalizedAt   DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  employee    Employee    @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([cooperativeId, employeeId])
  @@index([cooperativeId, fiscalYear, monthBs])
  @@index([cooperativeId, payrollRunId])
  @@index([employeeId])
  @@index([payrollRunId])
  @@map("payrolls")
}

model PayrollSettings {
  id                    String        @id @default(cuid())
  cooperativeId         String        @unique
  scheme                PayrollScheme @default(SSF)
  tdsConfig             Json // Tax slabs configuration
  glSalaryExpense       String // Chart of Accounts ID
  glSsfExpense          String
  glTdsPayable          String
  glSsfPayable          String
  glStaffLoanReceivable String
  glCashOrBank          String
  festivalBonusMonthBs  Int? // Month for festival bonus (default: Ashwin/Kartik)
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)

  @@map("payroll_settings")
}

// Governance
model Meeting {
  id             String                @id @default(cuid())
  cooperativeId  String
  title          String
  description    String?
  meetingType    String // "board", "general", "committee", "other"
  meetingNo      Int? // Auto-increment per cooperative
  date           DateTime? // Renamed from scheduledDate (nullable for migration)
  scheduledDate  DateTime? // Keep for backward compatibility during migration
  startTime      DateTime?
  endTime        DateTime?
  location       String?
  status         MeetingStatus         @default(PLANNED) // PLANNED, SCHEDULED, COMPLETED, CANCELLED
  workflowStatus MeetingWorkflowStatus @default(DRAFT) // DRAFT, LOCKED, MINUTED, FINALIZED
  baseAllowance  Float                 @default(0) // Default rate for this meeting
  totalExpense   Float                 @default(0) // Calculated after finalization
  createdBy      String? // User ID who created the meeting
  attendees      Json? // Array of attendee IDs (legacy, kept for backward compatibility)
  committeeId    String? // Link meeting to a committee
  minutesFileUrl String? // For file uploads
  minutesStatus  String                @default("DRAFT") // "DRAFT" or "FINALIZED" (legacy, kept for backward compatibility)
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt

  // Relations
  cooperative             Cooperative       @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  committee               Committee?        @relation(fields: [committeeId], references: [id])
  minutes                 MeetingMinute[]
  memberKYCApprovals      MemberKYC[]
  institutionKYCApprovals InstitutionKYC[]
  agendas                 MeetingAgenda[]
  meetingAttendees        MeetingAttendee[]
  managerReports          ManagerReport[]

  @@index([cooperativeId, committeeId])
  @@index([cooperativeId, meetingNo])
  @@map("meetings")
}

model MeetingMinute {
  id            String   @id @default(cuid())
  meetingId     String
  cooperativeId String
  agenda        String?
  discussion    String?
  decisions     String?
  actionItems   Json? // Array of action items
  recordedBy    String? // User ID
  recordedAt    DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  meeting     Meeting     @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  @@unique([meetingId])
  @@map("meeting_minutes")
}

model MeetingAgenda {
  id             String         @id @default(cuid())
  meetingId      String
  title          String
  description    String?
  decision       String? // The minute text
  decisionStatus DecisionStatus @default(PENDING) // PENDING, PASSED, REJECTED, DEFERRED
  order          Int            @default(0) // To sort agendas
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  // Relations
  meeting Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  @@index([meetingId, order])
  @@map("meeting_agendas")
}

model MeetingAttendee {
  id                String   @id @default(cuid())
  meetingId         String
  committeeMemberId String? // Link to CommitteeMember if applicable
  name              String? // For non-members (Invitee)
  role              String? // "Member", "Invitee", "Guest"
  isPresent         Boolean  @default(false)
  allowance         Float    @default(0)
  tdsAmount         Float    @default(0) // 15% of allowance
  netAmount         Float    @default(0) // allowance - tds
  isPaid            Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  meeting         Meeting          @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  committeeMember CommitteeMember? @relation(fields: [committeeMemberId], references: [id])

  @@index([meetingId])
  @@index([committeeMemberId])
  @@map("meeting_attendees")
}

model Committee {
  id                   String        @id @default(uuid())
  cooperativeId        String
  name                 String // e.g., "Board of Directors"
  nameNepali           String? // e.g., "सञ्चालक समिति"
  description          String?
  type                 CommitteeType @default(OTHER)
  isStatutory          Boolean       @default(false) // To distinguish statutory committees from ad-hoc ones
  defaultAllowanceRate Float         @default(0) // Default meeting allowance rate for this committee
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt

  // Relations
  cooperative Cooperative       @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  members     CommitteeMember[]
  tenures     CommitteeTenure[]
  meetings    Meeting[]

  @@index([cooperativeId])
  @@map("committees")
}

model CommitteeTenure {
  id          String    @id @default(uuid())
  committeeId String
  name        String // e.g., "Term 2080-2084"
  startDate   DateTime
  endDate     DateTime? // Null means currently active/ongoing
  notes       String?
  isCurrent   Boolean   @default(false) // Helper flag for quick queries
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  committee Committee         @relation(fields: [committeeId], references: [id], onDelete: Cascade)
  members   CommitteeMember[]

  @@map("committee_tenures")
}

model CommitteeMember {
  id             String    @id @default(uuid())
  committeeId    String
  memberId       String // Link to the actual Cooperative Member
  tenureId       String? // Optional: Some members might be ad-hoc outside a tenure
  position       String // e.g., "Chairman", "Secretary"
  positionNepali String?
  photoPath      String? // Specific photo for the committee display (if different from profile)
  startDate      DateTime
  endDate        DateTime?
  isActive       Boolean   @default(true)
  isActing       Boolean   @default(false) // Karyabahak (Acting) check
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  committee        Committee         @relation(fields: [committeeId], references: [id], onDelete: Cascade)
  member           Member            @relation(fields: [memberId], references: [id])
  tenure           CommitteeTenure?  @relation(fields: [tenureId], references: [id])
  meetingAttendees MeetingAttendee[]

  @@index([committeeId, isActive])
  @@map("committee_members")
}

model AGM {
  id                     String    @id @default(uuid())
  cooperativeId          String
  fiscalYear             String // e.g., "2080/081"
  agmNumber              Int // e.g., 15 (15th AGM)
  bookCloseDate          DateTime? // Share book close date
  scheduledDate          DateTime
  location               String?
  totalMembers           Int       @default(0) // Snapshot of total members at time of AGM
  presentMembers         Int       @default(0)
  quorumThresholdPercent Float     @default(51.0) // Usually 51%
  approvedDividendBonus  Float? // %
  approvedDividendCash   Float? // %
  status                 AGMStatus @default(PLANNED)
  notes                  String? // General summary
  minutesFileUrl         String? // Link to scanned minutes PDF
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)

  @@unique([cooperativeId, fiscalYear])
  @@map("agms")
}

// Inventory Management
model InventoryCategory {
  id            String   @id @default(cuid())
  cooperativeId String
  name          String
  description   String?
  parentId      String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  cooperative Cooperative         @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  parent      InventoryCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    InventoryCategory[] @relation("CategoryHierarchy")
  items       InventoryItem[]

  @@unique([cooperativeId, name])
  @@map("inventory_categories")
}

model InventoryItem {
  id            String   @id @default(cuid())
  cooperativeId String
  categoryId    String?
  code          String
  name          String
  description   String?
  unit          String // "piece", "kg", "liter", etc.
  quantity      Decimal  @default(0) @db.Decimal(15, 2)
  minQuantity   Decimal? @db.Decimal(15, 2)
  maxQuantity   Decimal? @db.Decimal(15, 2)
  unitPrice     Decimal? @db.Decimal(15, 2)
  location      String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  cooperative Cooperative        @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  category    InventoryCategory? @relation(fields: [categoryId], references: [id])

  @@unique([cooperativeId, code])
  @@map("inventory_items")
}

// Compliance & Audit
model AuditLog {
  id            String   @id @default(cuid())
  cooperativeId String
  action        String // "create", "update", "delete", "view", "export", etc.
  entityType    String // "user", "member", "loan", "saving", etc.
  entityId      String?
  userId        String? // User who performed the action
  details       Json? // Additional details about the action
  ipAddress     String?
  userAgent     String?
  timestamp     DateTime @default(now())

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)

  @@index([cooperativeId, timestamp])
  @@index([cooperativeId, action])
  @@index([cooperativeId, entityType])
  @@index([cooperativeId, userId])
  @@index([entityType, entityId])
  @@index([timestamp])
  @@map("audit_logs")
}

// AML/KYM Models
enum TransactionCounterpartyType {
  MEMBER
  GOVERNMENT_ENTITY
  EMPLOYEE
  BANK
  OTHER
}

enum AmlFlagType {
  TTR
  STR
  HIGH_RISK
  CONTINUOUS_MONITORING
  SUSPICIOUS_ATTEMPT
}

model ProcessedAmlEvents {
  transactionId String   @id
  memberId      String
  cooperativeId String
  amount        Decimal  @db.Decimal(15, 2)
  processedAt   DateTime @default(now())

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)

  @@map("processed_aml_events")
}

model AmlFlag {
  id            String      @id @default(cuid())
  memberId      String
  cooperativeId String
  type          AmlFlagType
  details       Json
  isAttempted   Boolean     @default(false) // For manual SARs
  status        String      @default("pending")
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  member      Member      @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([cooperativeId, memberId])
  @@index([cooperativeId, type])
  @@index([cooperativeId, status])
  @@index([memberId])
  @@map("aml_flags")
}

model AmlTtrReport {
  id            String                      @id @default(cuid())
  forDate       DateTime
  memberId      String
  cooperativeId String
  totalAmount   Decimal                     @db.Decimal(15, 2)
  counterparty  TransactionCounterpartyType @default(MEMBER) // For exemption logic
  status        String                      @default("pending")
  deadline      DateTime
  remarks       String? // For rejection/correction reasons
  xmlPath       String?
  createdAt     DateTime                    @default(now())
  updatedAt     DateTime                    @updatedAt

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  member      Member      @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([cooperativeId, memberId])
  @@index([cooperativeId, forDate])
  @@index([cooperativeId, status])
  @@index([memberId])
  @@index([forDate])
  @@map("aml_ttr_reports")
}

model SourceOfFundsDeclaration {
  id             String   @id @default(cuid())
  transactionId  String
  memberId       String
  cooperativeId  String
  declaredText   String
  attachmentPath String? // Path to supporting document (e.g., land sale deed)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  member      Member      @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([cooperativeId, memberId])
  @@index([cooperativeId, transactionId])
  @@index([memberId])
  @@index([transactionId])
  @@map("source_of_funds_declarations")
}

model AccountSignatory {
  id            String   @id @default(cuid())
  accountId     String // Can reference SavingAccount or other account types
  accountType   String // "saving", "loan", etc.
  memberId      String
  cooperativeId String
  role          String // e.g., "Guardian", "Operator"
  biometricData String? // Stores ISO 19794-2 template or encrypted path to secure storage
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  member      Member      @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([cooperativeId])
  @@index([memberId])
  @@index([accountId])
  @@map("account_signatories")
}

model WhitelistedMatch {
  id               String   @id @default(cuid())
  memberId         String
  cooperativeId    String
  sanctionListId   String // ID from the source sanction list
  sanctionListType String // "UN", "HOME_MINISTRY"
  reason           String
  whitelistedById  String // User ID who whitelisted
  createdAt        DateTime @default(now())

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)

  @@unique([memberId, sanctionListId, sanctionListType])
  @@map("whitelisted_matches")
}

model SensitiveDataAccessLog {
  id            String   @id @default(cuid())
  userId        String
  cooperativeId String
  endpoint      String // e.g., GET /api/compliance/aml/cases
  accessedAt    DateTime @default(now())

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)

  @@map("sensitive_data_access_logs")
}

model SanctionListUN {
  id            String   @id @default(cuid())
  cooperativeId String
  fullName      String
  aliases       Json? // Array of alternative names
  dob           String? // Date of birth
  nationality   String?
  lastUpdated   DateTime @default(now())
  createdAt     DateTime @default(now())

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)

  @@map("sanction_list_un")
}

model SanctionListHomeMinistry {
  id            String   @id @default(cuid())
  cooperativeId String
  fullName      String
  aliases       Json? // Array of alternative names
  nationalId    String?
  noticeRef     String?
  lastUpdated   DateTime @default(now())
  createdAt     DateTime @default(now())

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)

  @@map("sanction_list_home_ministry")
}

model AmlCase {
  id             String      @id @default(cuid())
  memberId       String
  cooperativeId  String
  type           AmlFlagType
  status         String      @default("open")
  notes          String?
  isConfidential Boolean     @default(true)
  createdAt      DateTime    @default(now())
  closedAt       DateTime?
  updatedAt      DateTime    @updatedAt

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  member      Member      @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([cooperativeId, memberId])
  @@index([cooperativeId, status])
  @@index([cooperativeId, type])
  @@index([memberId])
  @@map("aml_cases")
}

// Training & HR Module Extensions
model TrainingSession {
  id            String   @id @default(cuid())
  cooperativeId String
  title         String
  description   String?
  sessionType   String // "aml_workshop", "kyc_training", etc.
  conductedBy   String? // User ID
  sessionDate   DateTime
  duration      Int? // Duration in minutes
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  cooperative Cooperative          @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  attendance  TrainingAttendance[]

  @@map("training_sessions")
}

model TrainingAttendance {
  id            String   @id @default(cuid())
  sessionId     String
  employeeId    String
  cooperativeId String
  attended      Boolean  @default(true)
  remarks       String?
  createdAt     DateTime @default(now())

  // Relations
  cooperative Cooperative     @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  session     TrainingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  employee    Employee        @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([sessionId, employeeId])
  @@map("training_attendance")
}

// Manager's Report
model ManagerReport {
  id            String      @id @default(cuid())
  cooperativeId String
  cooperative   Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)

  title      String // e.g. "2081 Shrawan - Monthly Progress Report"
  fiscalYear String // e.g. "2081"
  month      String // e.g. "Shrawan", "Ashad"

  // Financial Snapshot (JSON for structured data)
  financialData     Json? // Balance sheet, P&L, PEARLS ratios
  previousMonthData Json? // Previous month's values for comparison

  // Member Data
  memberData Json? // New/closed members, KYC status, AML flags

  // Loan Data
  loanData Json? // Approved loans by level, overdue, recovery, insider lending

  // Liquidity Data
  liquidityData Json? // Liabilities, top 20 lists, gap analysis

  // Governance Data
  governanceData Json? // Committee meetings, complaints, circulars, policies

  // Narrative Sections (Rich Text)
  description String? @db.Text // Manager's overall analysis
  challenges  String? @db.Text // Problems and challenges
  plans       String? @db.Text // Future plans
  suggestions String? @db.Text // Manager's suggestions to board

  status      ReportStatus @default(DRAFT)
  finalizedAt DateTime?
  finalizedBy String? // User ID

  // Link to meeting (optional)
  presentedInMeetingId String?
  meeting              Meeting? @relation(fields: [presentedInMeetingId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([cooperativeId, fiscalYear, month])
  @@index([cooperativeId, status])
  @@map("manager_reports")
}

// Day End / Day Begin (EOD/BOD) Management
model DayBook {
  id                String        @id @default(cuid())
  cooperativeId     String
  date              DateTime // The "System Date" for accounting
  status            DayBookStatus @default(OPEN)
  dayBeginBy        String? // User ID
  dayEndBy          String? // User ID
  openingCash       Decimal?      @db.Decimal(18, 2)
  closingCash       Decimal?      @db.Decimal(18, 2)
  transactionsCount Int           @default(0)
  version           Int           @default(1) // Optimistic Locking
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relations
  cooperative    Cooperative        @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  dayBeginByUser User?              @relation("DayBeginBy", fields: [dayBeginBy], references: [id], onDelete: SetNull)
  dayEndByUser   User?              @relation("DayEndBy", fields: [dayEndBy], references: [id], onDelete: SetNull)
  settlements    TellerSettlement[]

  @@unique([cooperativeId, date])
  @@index([cooperativeId, status])
  @@index([cooperativeId, date])
  @@map("day_books")
}

model TellerSettlement {
  id               String                 @id @default(cuid())
  dayBookId        String
  cooperativeId    String // Direct relation to Cooperative for performance
  tellerId         String // User ID of the teller
  physicalCash     Decimal                @db.Decimal(18, 2)
  systemCash       Decimal                @db.Decimal(18, 2)
  difference       Decimal                @db.Decimal(18, 2)
  denominationData Json? // Denomination count data
  status           TellerSettlementStatus @default(PENDING)
  settlementRef    String                 @unique // Unique for Idempotency
  executedBy       String // User ID
  executedAt       DateTime               @default(now())
  approvalBy       String? // User ID (Optional)
  approvalAt       DateTime? // DateTime (Optional)
  attachmentUrl    String? // Scan/Proof document URL
  rejectionReason  String? // If unsettled/rejected
  isForceClosed    Boolean                @default(false)
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt

  // Relations
  cooperative    Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  dayBook        DayBook     @relation(fields: [dayBookId], references: [id], onDelete: Cascade)
  teller         User        @relation("TellerSettlements", fields: [tellerId], references: [id], onDelete: Restrict)
  executedByUser User        @relation("SettlementExecutedBy", fields: [executedBy], references: [id], onDelete: Restrict)
  approvalByUser User?       @relation("SettlementApprovedBy", fields: [approvalBy], references: [id], onDelete: SetNull)

  @@index([dayBookId])
  @@index([cooperativeId])
  @@index([tellerId])
  @@index([settlementRef])
  @@index([status])
  @@index([cooperativeId, status])
  @@map("teller_settlements")
}

// Notifications
enum NotificationChannel {
  SMS
  EMAIL
  IN_APP
  PUSH
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  READ
}

model Notification {
  id            String              @id @default(cuid())
  cooperativeId String
  userId        String? // Target user (null for broadcast notifications)
  type          String // Notification type (e.g., "meeting_scheduled", "loan_approved", "payment_received")
  channel       NotificationChannel // SMS, EMAIL, IN_APP, PUSH
  title         String
  message       String
  status        NotificationStatus  @default(PENDING)
  phone         String? // Phone number for SMS
  email         String? // Email address for EMAIL
  metadata      Json? // Additional data (e.g., meeting ID, transaction ID)
  sentAt        DateTime? // When notification was sent
  readAt        DateTime? // When notification was read (for IN_APP)
  errorMessage  String? // Error message if status is FAILED
  retryCount    Int                 @default(0)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  user        User?       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([cooperativeId])
  @@index([userId])
  @@index([type])
  @@index([channel])
  @@index([status])
  @@index([cooperativeId, userId, status])
  @@index([cooperativeId, status])
  @@index([createdAt])
  @@map("notifications")
}

// Generic Workflow History - for tracking workflow transitions for any entity type
model GenericWorkflowHistory {
  id            String   @id @default(uuid())
  cooperativeId String
  entityType    String // e.g., 'Member', 'LoanApplication', 'Meeting', etc.
  entityId      String // ID of the entity that transitioned
  workflowName  String // Name of the workflow (e.g., 'member-onboarding', 'loan-approval')
  fromStatus    String? // Previous state (null for initial creation)
  toStatus      String // New state
  changedById   String? // ID of the user who made the change
  changedBy     User?    @relation(fields: [changedById], references: [id], onDelete: SetNull)
  remarks       String? // Optional remarks about the transition
  metadata      Json? // Additional metadata about the transition
  changedAt     DateTime @default(now())

  // Relations
  cooperative Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)

  @@index([cooperativeId])
  @@index([entityType, entityId])
  @@index([workflowName])
  @@index([cooperativeId, entityType, entityId])
  @@index([changedAt])
  @@map("generic_workflow_history")
}
